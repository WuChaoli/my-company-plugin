# Agents 使用指南

本指南详细说明项目中所有可用 agents 的使用场景、触发条件和最佳实践。

## 快速参考表

| Agent | 使用场景 | 触发关键词/条件 |
|-------|---------|----------------|
| **code-reviewer** | 代码审查 | 完成主要项目步骤、实现功能后 |
| **lite-dev** | 快速开发 | 需要编写/修改代码、修复bug、编写测试 |
| **code-explorer** | 代码搜索 | 需要查找代码、了解代码结构、搜索函数/类定义 |
| **context-manager** | 上下文管理 | "开始新需求"、"归档上下文"、"查看活跃上下文" |
| **librarian** | 文档管理 | 需要处理文档、组织文件结构、更新技术文档 |
| **web-browser** | 网页浏览 | 需要浏览网页、获取网页内容、网页交互 |
| **smart-compact-agent** | 智能压缩 | 上下文使用率达到阈值 |

## 详细使用说明

### 开发类 Agents

#### 1. lite-dev - 轻量级开发助手

**用途**：快速功能实现、代码修复、类型补充、测试编写

**何时使用**：
- 需要快速编写新功能或修改现有代码
- 需要修复简单的 bug
- 需要添加 TypeScript 类型标注
- 需要编写单元测试或集成测试
- 需要进行代码重构

**触发条件**：
- 用户明确要求"实现"、"开发"、"编写"代码
- 用户报告 bug 需要修复
- 用户要求补充类型或编写测试

**不适用场景**：
- 需要深入理解代码库结构（使用 code-explorer）
- 需要代码审查（使用 code-reviewer）
- 需要处理文档（使用 librarian）

**核心能力**：
- 功能实现（函数、类、模块）
- 快速修复（bug、逻辑错误）
- 类型补充（TypeScript 类型标注）
- 测试编写（单元测试、集成测试）

**内置技能**：
- doc-location-manager - 文档位置管理
- systematic-debugging - 系统化调试
- tdd-workflow - 测试驱动开发
- test-driven-development - TDD 最佳实践

---

#### 2. code-reviewer - 代码审查专家

**用途**：审查已完成的项目步骤，确保代码质量和计划一致性

**何时使用**：
- 完成了计划中的主要项目步骤
- 实现了重要功能需要验证
- 完成了某个架构文档中定义的步骤
- 需要确保代码符合质量标准

**触发条件**：
- 用户说"完成了步骤 X"
- 用户说"实现了功能 Y"
- 完成了一个逻辑完整的代码块
- 准备提交或合并代码前

**审查内容**：
1. **计划一致性**：对照原始计划检查实现
2. **代码质量**：错误处理、类型安全、命名规范
3. **架构设计**：SOLID 原则、关注点分离
4. **文档标准**：注释、文档、代码风格
5. **问题识别**：关键问题、重要问题、建议

**输出格式**：
- 结构化的问题分类（Critical/Important/Suggestions）
- 具体的代码示例和修复建议
- 计划偏差分析

---

### 搜索和分析类 Agents

#### 3. code-explorer - 代码搜索专家

**用途**：精准的本地代码查询和代码结构分析

**何时使用**：
- 需要查找函数、类、变量的定义
- 需要查找某个符号的所有引用位置
- 需要了解代码的组织结构
- 需要搜索特定的代码模式
- 需要分析模块依赖关系

**触发条件**：
- 用户问"在哪里定义了 X"
- 用户问"X 在哪些地方被使用了"
- 用户说"分析代码结构"
- 用户问"这个项目的 X 模块是怎么组织的"

**核心能力**：
- 符号级代码搜索（使用 Serena MCP）
- LSP 语义理解（跳转定义、查找引用）
- 代码结构分析
- 定义和引用查找
- 模式搜索

**工具优先级**：
1. **Serena MCP 工具**（符号级理解）
   - `mcp__serena__find_symbol` - 符号搜索
   - `mcp__serena__get_definition` - 跳转定义
   - `mcp__serena__get_references` - 查找引用
   - `mcp__serena__get_symbols` - 文件符号

2. **LSP 原生功能**（语义级别）
   - `goToDefinition` - 精确跳转
   - `findReferences` - 查找引用
   - `documentSymbol` - 文档符号
   - `workspaceSymbol` - 工作区符号

3. **传统工具**（文本级别）
   - `Grep` - 文本搜索
   - `Glob` - 文件匹配
   - `Read` - 读取内容

**重要提醒**：
- 首次使用需激活 Serena 项目：`mcp__serena__activate_project project="."`
- 利用 `.serena/memories/` 中的项目记忆
- 只读操作，不修改代码

---

### 管理类 Agents

#### 4. context-manager - 上下文管理专家

**用途**：管理开发上下文的完整生命周期

**何时使用**：
- 用户说"开始新需求"或"初始化上下文"
- 用户说"归档上下文"
- 用户说"查看活跃上下文"
- 用户提到"context engineering"或"上下文管理"

**核心职责**：
1. **初始化新上下文** - 创建结构化的开发上下文
2. **列出活跃上下文** - 查看当前开发工作
3. **归档完成的上下文** - 标记工作为已完成
4. **整理文档结构** - 优化上下文文档

**工作流程**：
- 优先使用脚本（如果可用）
- 参考 context-engineering skill 中的规范
- 创建符合标准的目录结构和元数据

**依赖技能**：
- context-engineering - 上下文工程规范

---

#### 5. librarian - 图书管理员

**用途**：文档的阅读、组织、移动和编辑维护

**何时使用**：
- 需要阅读和理解文档内容
- 需要重新组织文档结构
- 需要移动或重命名文档
- 需要批量编辑文档
- 需要创建或更新技术文档
- 需要维护文档索引

**核心职责**：
1. **文档管理** - 组织、移动、阅读、索引
2. **文档维护** - 创建、更新、审查、标准化

**文档组织结构**：
```
docs/
├── static/              # 静态文档（长期维护）
│   ├── architecture/    # 架构设计
│   ├── api/            # API文档
│   ├── guide/          # 使用指南
│   └── spec/           # 需求规格
├── contexts/           # 开发上下文（按时间+功能）
└── archive/            # 归档文档（只读）
```

**不适用场景**：
- 纯代码实现（使用 lite-dev）
- 代码审查（使用 code-reviewer）
- 测试编写（使用 lite-dev）

---

### 专用类 Agents

#### 6. web-browser - 网页浏览专家

**用途**：网页浏览、截图、性能分析、DOM 操作和信息提取

**何时使用**：
- 需要浏览网页获取信息
- 需要与网页进行交互（点击、填写表单）
- 需要进行网页截图
- 需要分析网页性能
- 需要提取网页内容

**工具选择**：
- **静态页面** → WebFetch（快速高效）
- **动态页面/需交互** → Chrome DevTools
- **搜索需求** → WebSearch

**核心流程**：
1. 理解信息获取需求
2. 选择合适的工具
3. 执行浏览/交互
4. 提取和总结信息

**特殊场景处理**：
- 分页内容
- 登录/认证
- 无限滚动页面
- 弹窗和对话框

---

#### 7. smart-compact-agent - 智能压缩专家

**用途**：当上下文使用率达到阈值时，执行智能压缩

**何时使用**：
- 上下文使用率接近限制
- 需要清理会话历史以释放空间
- 系统自动触发压缩

**压缩策略**：
1. **前70%的历史消息** - 智能压缩
   - 文件内容：保留路径和首行
   - 网页内容：保留链接和标题
   - 普通对话：压缩关键信息

2. **后30%的消息** - 完全保留

**输出**：
- 压缩报告（统计信息）
- 压缩后的记忆文件（`.claude/session-memory.md.tmp`）

---

## Agent 选择决策树

```
开始
  |
  ├─ 需要编写/修改代码？
  |   └─ 是 → lite-dev
  |
  ├─ 需要查找代码/理解结构？
  |   └─ 是 → code-explorer
  |
  ├─ 完成了主要步骤/需要审查？
  |   └─ 是 → code-reviewer
  |
  ├─ 需要处理文档/组织文件？
  |   └─ 是 → librarian
  |
  ├─ 需要浏览网页？
  |   └─ 是 → web-browser
  |
  ├─ 开始新需求/归档上下文？
  |   └─ 是 → context-manager
  |
  └─ 上下文空间不足？
      └─ 是 → smart-compact-agent
```

## 组合使用场景

### 场景1：新功能开发
1. **context-manager** - 初始化新上下文
2. **lite-dev** - 实现功能
3. **code-reviewer** - 审查实现
4. **librarian** - 更新文档

### 场景2：代码库理解
1. **code-explorer** - 分析代码结构
2. **context-manager** - 创建分析上下文
3. **librarian** - 整理文档

### 场景3：Bug 修复
1. **code-explorer** - 定位问题代码
2. **lite-dev** - 修复 bug
3. **code-reviewer** - 验证修复

### 场景4：性能优化
1. **web-browser** - 分析网页性能（如适用）
2. **code-explorer** - 查找性能瓶颈
3. **lite-dev** - 优化代码

## 最佳实践

### 1. 明确任务类型
在选择 agent 前，先明确任务的性质：
- 是开发任务？搜索任务？管理任务？
- 需要修改代码还是只读分析？
- 是一次性任务还是需要持续管理？

### 2. 使用正确的工具
- 代码搜索优先使用 Serena MCP（符号级）
- 文档处理使用 librarian
- 上下文管理使用 context-manager

### 3. 遵循工作流程
- 新功能：初始化上下文 → 开发 → 审查 → 文档
- Bug 修复：定位 → 修复 → 验证
- 代码理解：搜索 → 分析 → 文档

### 4. 组合使用 Agents
不要局限于单个 agent，根据任务需要组合使用多个 agents。

### 5. 利用 Agent 的内置技能
每个 agent 都加载了相关的 skills，充分利用这些技能可以提高效率。

## 注意事项

### Agent 职责边界
- **lite-dev** 不负责代码审查
- **code-explorer** 不修改代码
- **librarian** 不负责纯代码实现
- **code-reviewer** 只在完成主要步骤后使用

### 首次使用注意事项
- **code-explorer**：首次使用需激活 Serena 项目
- **context-manager**：检查是否有可用脚本

### 输出格式规范
- 代码引用使用 markdown 链接格式：`[filename:line](path#Lline)`
- 搜索结果按相关性排序
- 提供清晰的上下文说明

## 总结

选择合适的 agent 是提高工作效率的关键：

1. **开发任务** → lite-dev
2. **搜索分析** → code-explorer
3. **代码审查** → code-reviewer
4. **上下文管理** → context-manager
5. **文档管理** → librarian
6. **网页浏览** → web-browser
7. **空间压缩** → smart-compact-agent

根据任务的性质和需求，灵活选择和组合使用 agents。
