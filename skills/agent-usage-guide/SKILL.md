---
name: agent-usage-guide
description: Agent 使用规范指南。帮助大模型理解在什么场景下应该调用什么 agents。包含项目中所有 agents 的使用场景、触发条件、判断规则和禁止场景。当需要决定使用哪个 agent、理解 agent 职责边界、或查找特定任务的 agent 时使用。
---

# Agent 使用规范指南

本指南提供项目中所有 agents 的选择规则、职责边界和禁止场景，确保在正确的时机调用正确的 agent。

## 快速决策树

```
用户请求
    │
    ├─ 需要编写/修改代码?
    │   ├─ 小型修改(<100行) → lite-dev
    │   ├─ 结构化重构 → refactor-engineer
    │   └─ 新功能开发 → tdd-developer
    │
    ├─ 需要查找/理解代码?
    │   ├─ 精确符号级查询 → code-explorer (Serena)
    │   └─ 快速模式搜索 → 使用 Grep/Glob
    │
    ├─ 需要审查代码?
    │   ├─ 完成主要步骤 → code-reviewer
    │   └─ PR审查 → code-review:code-review
    │
    ├─ 需要处理文档?
    │   ├─ 文档组织/移动 → librarian
    │   ├─ 创建文档 → lite-dev + librarian
    │   └─ 上下文管理 → context-manager
    │
    ├─ 需要浏览网页?
    │   └─ web-browser 或 web-browser-agent
    │
    ├─ 上下文空间不足?
    │   └─ smart-compact-agent
    │
    └─ 不确定? → general-purpose
```

---

## Agents 详细规范

### 1. lite-dev (轻量开发)

**Agent 名称**: `lite-dev`

**适用范围**:
- 快速功能实现和小型代码修改
- 单文件修改,变更量 <100 行
- 明确需求的 bug 修复
- 类型补充和小型重构

**判断规则**:
1. ✅ 修改范围是否明确?
2. ✅ 变更量是否 <100 行?
3. ✅ 是否不需要深入理解整体架构?
4. ✅ 是否是单文件或少数文件修改?

**禁止场景**:
- ❌ 跨多个文件的结构性修改 → 使用 `refactor-engineer`
- ❌ 需要架构设计 → 使用 `architect` 或 `Plan`
- ❌ 代码审查 → 使用 `code-reviewer`
- ❌ 深度代码库分析 → 使用 `code-explorer`

**典型触发词**:
- "实现"、"开发"、"修复 bug"、"写测试"
- "添加类型"、"补充注释"、"小修改"

---

### 2. refactor-engineer (重构工程师)

**Agent 名称**: `refactor-engineer`

**适用范围**:
- 结构性代码重构
- 跨多个文件的架构调整
- 代码质量优化
- 技术债务清理

**判断规则**:
1. ✅ 是否涉及文件间结构关系?
2. ✅ 是否需要保持功能不变式优化?
3. ✅ 变更是否影响多个模块?
4. ✅ 是否需要理解代码整体结构?

**禁止场景**:
- ❌ 新功能开发 → 使用 `tdd-developer`
- ❌ 简单单行修改 → 使用 `lite-dev`
- ❌ 仅修改 bug 逻辑 → 使用 `lite-dev`

**典型触发词**:
- "重构"、"提取"、"优化结构"
- "减少重复"、"改善架构"

---

### 3. tdd-developer (TDD开发工程师)

**Agent 名称**: `tdd-developer`

**适用范围**:
- 使用 TDD 流程开发新功能
- 需要高测试覆盖率的开发
- 复杂业务逻辑实现

**判断规则**:
1. ✅ 是否是新功能开发?
2. ✅ 是否需要先写测试?
3. ✅ 业务逻辑是否复杂?
4. ✅ 是否需要 >=80% 测试覆盖率?

**禁止场景**:
- ❌ 简单 bug 修复 → 使用 `lite-dev`
- ❌ 类型补充等小修改 → 使用 `lite-dev`
- ❌ 仅写测试不写代码 → 使用 `test-engineer`

**典型触发词**:
- "开发新功能"、"TDD"、"测试驱动"
- "实现业务逻辑"

---

### 4. code-explorer (代码探索者)

**Agent 名称**: `code-explorer`

**适用范围**:
- 符号级代码查询和导航
- 函数/类定义和引用查找
- 代码结构和依赖分析
- 使用 Serena MCP 进行语义理解

**判断规则**:
1. ✅ 是否需要查找定义位置?
2. ✅ 是否需要查找所有引用?
3. ✅ 是否需要理解代码结构?
4. ✅ 是否需要符号级而非文本级搜索?

**禁止场景**:
- ❌ 修改代码 → 使用 `lite-dev` 或 `refactor-engineer`
- ❌ 代码审查 → 使用 `code-reviewer`
- ❌ 简单文本搜索 → 使用 Grep/Glob

**典型触发词**:
- "在哪里定义"、"查找"、"搜索"
- "分析结构"、"找出所有引用"

**工具优先级**:
1. Serena MCP (符号级)
2. LSP 功能 (语义级)
3. Grep/Glob (文本级)

---

### 5. code-reviewer (代码审查者)

**Agent 名称**: `code-reviewer`

**适用范围**:
- 审查已完成的主要步骤
- 对照计划检查实现
- 代码质量评估
- 架构设计审查

**判断规则**:
1. ✅ 是否完成了主要开发步骤?
2. ✅ 是否需要对照原始需求/计划验证?
3. ✅ 是否需要评估代码质量?
4. ✅ 用户是否提到"完成了"、"实现了"?

**禁止场景**:
- ❌ 编写代码 → 使用 `lite-dev` 或 `tdd-developer`
- ❌ 执行测试 → 在主会话中使用 Bash
- ❌ 查找代码 → 使用 `code-explorer`

**典型触发词**:
- "审查"、"review"、"完成了"
- "检查实现"、"验证代码"

---

### 6. test-engineer (测试工程师)

**Agent 名称**: `test-engineer`

**适用范围**:
- 编写和优化测试用例
- 提高测试覆盖率
- 测试策略设计
- 测试问题诊断

**判断规则**:
1. ✅ 是否主要工作是编写测试?
2. ✅ 是否需要设计测试策略?
3. ✅ 是否需要提高覆盖率?
4. ✅ 是否仅涉及测试相关代码?

**禁止场景**:
- ❌ 编写功能代码 → 使用 `tdd-developer` (TDD流程)
- ❌ 修复功能 bug → 使用 `lite-dev`
- ❌ 需要同步编写测试和功能 → 使用 `tdd-developer`

**典型触发词**:
- "写测试"、"测试覆盖率"、"测试策略"
- "优化测试"

---

### 7. architect (架构师)

**Agent 名称**: `architect`

**适用范围**:
- 系统架构设计
- 技术方案选型
- 模块划分和接口设计
- 架构文档编写

**判断规则**:
1. ✅ 是否需要设计整体架构?
2. ✅ 是否需要技术选型决策?
3. ✅ 是否涉及模块间关系设计?
4. ✅ 是否需要编写架构文档?

**禁止场景**:
- ❌ 具体代码实现 → 使用 `lite-dev` 或 `tdd-developer`
- ❌ 小型功能开发 → 使用 `lite-dev`
- ❌ 仅重构代码 → 使用 `refactor-engineer`

**典型触发词**:
- "架构设计"、"技术选型"、"模块划分"
- "设计方案"、"架构文档"

---

### 8. requirement-planner (需求规划师)

**Agent 名称**: `requirement-planner`

**适用范围**:
- 需求分析和澄清
- 功能规划
- 用户故事编写
- 验收标准定义

**判断规则**:
1. ✅ 需求是否不明确需要澄清?
2. ✅ 是否需要规划功能步骤?
3. ✅ 是否需要编写用户故事?
4. ✅ 是否需要定义验收标准?

**禁止场景**:
- ❌ 直接实现功能 → 需求明确后使用 `tdd-developer`
- ❌ 编写代码 → 需求明确后使用开发者 agents
- ❌ 仅文档组织 → 使用 `librarian`

**典型触发词**:
- "需求分析"、"规划"、"用户故事"
- "验收标准"、"功能设计"

---

### 9. context-manager (上下文管理者)

**Agent 名称**: `context-manager`

**适用范围**:
- 上下文工程生命周期管理
- 创建开发上下文
- 归档已完成需求
- 查看活跃上下文

**判断规则**:
1. ✅ 是否需要创建新的开发上下文?
2. ✅ 是否需要归档已完成工作?
3. ✅ 用户是否提到"开始新需求"、"归档"?
4. ✅ 是否需要查看活跃工作?

**禁止场景**:
- ❌ 编写代码 → 使用开发类 agents
- ❌ 仅编辑单个文档 → 使用 `librarian` 或 `lite-dev`
- ❌ 仅查找代码 → 使用 `code-explorer`

**典型触发词**:
- "开始新需求"、"初始化上下文"
- "归档上下文"、"查看活跃上下文"

**依赖技能**: `context-engineering`

---

### 10. librarian (图书管理员)

**Agent 名称**: `librarian`

**适用范围**:
- 文档组织和移动
- 批量文档编辑
- 文档索引维护
- 文档阅读和检索

**判断规则**:
1. ✅ 是否涉及文档结构组织?
2. ✅ 是否需要移动/重组文档?
3. ✅ 是否批量编辑文档?
4. ✅ 是否主要处理文档而非代码?

**禁止场景**:
- ❌ 编写功能代码 → 使用 `lite-dev`
- ❌ 代码审查 → 使用 `code-reviewer`
- ❌ 仅创建新文档 → `lite-dev` + `librarian` 组合

**典型触发词**:
- "组织文档"、"移动文档"、"批量编辑"
- "文档结构"、"更新文档"

---

### 11. web-browser / web-browser-agent (网页浏览器)

**Agent 名称**: `web-browser` 或 `web-browser-agent`

**适用范围**:
- 网页内容获取
- 网页交互(点击、填写表单)
- 网页截图
- 网页性能分析

**判断规则**:
1. ✅ 是否需要访问网页?
2. ✅ 是否需要与网页交互?
3. ✅ 是否需要网页截图?
4. ✅ 是否需要分析网页内容?

**禁止场景**:
- ❌ 仅搜索信息 → 使用 `WebSearch`
- ❌ 本地代码操作 → 使用其他 agents
- ❌ API 调用而非网页 → 使用 Bash 直接调用

**典型触发词**:
- "打开网页"、"浏览网页"、"截图"
- "填写表单"、"点击"、"网页内容"

**工具选择**:
- 静态页面 → `WebFetch`
- 动态页面 → `Chrome DevTools` (MCP)
- 搜索 → `WebSearch`

---

### 12. smart-compact-agent (智能压缩)

**Agent 名称**: `smart-compact-agent`

**适用范围**:
- 上下文空间不足时的自动压缩
- 历史消息智能归档

**判断规则**:
1. ✅ 上下文使用率是否达到阈值(如80%)?
2. ✅ 是否需要继续对话但空间不足?

**禁止场景**:
- ❌ 主动压缩 → 仅在达到阈值时使用
- ❌ 用户明确要求不压缩时

**触发条件**: 自动触发,无需手动调用

**压缩策略**:
- 前 70% 历史消息 → 智能压缩(文件保留路径,网页保留链接)
- 后 30% 消息 → 完全保留

---

## Agent 组合模式

### 模式 1: TDD 新功能开发
```
requirement-planner (需求澄清)
    ↓
tdd-developer (TDD 开发)
    ↓
code-reviewer (代码审查)
    ↓
librarian (更新文档)
```

### 模式 2: 结构化重构
```
architect (架构设计)
    ↓
refactor-engineer (执行重构)
    ↓
test-engineer (更新测试)
    ↓
code-reviewer (验证重构)
```

### 模式 3: Bug 修复
```
code-explorer (定位问题)
    ↓
lite-dev (修复 bug)
    ↓
test-engineer (补充测试)
    ↓
code-reviewer (验证修复)
```

### 模式 4: 上下文初始化 + 开发
```
context-manager (初始化上下文)
    ↓
<选择合适的开发 agent>
    ↓
context-manager (归档上下文)
```

---

## 选择流程

```
1. 理解用户意图
   ↓
2. 检查快速决策树
   ↓
3. 确认 agent 适用范围
   ↓
4. 验证判断规则(全部满足)
   ↓
5. 检查禁止场景(不触发)
   ↓
6. 选择合适的 agent
   ↓
7. 如需多步骤,组合使用 agents
```

---

## 常见错误

### ❌ 职责混淆
- 错误: 用 `lite-dev` 进行架构设计
- 正确: 用 `architect` 设计,再用 `lite-dev` 实现

### ❌ 禁止场景忽略
- 错误: 用 `code-reviewer` 编写代码
- 正确: 用 `lite-dev` 或 `tdd-developer` 编写

### ❌ 判断规则不完整
- 错误: 仅凭单个关键词选择 agent
- 正确: 完整检查所有判断规则

---

**核心原则**: 准确选择 agent 是高效协作的基础。根据任务性质、变更范围、复杂度和阶段,选择最匹配的 agent。
